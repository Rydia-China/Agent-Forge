generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Skill — 遵循 Agent Skills 开放标准 (agentskills.io)
/// 实体表只保留身份字段 + production 指针，内容存在 SkillVersion
model Skill {
  id                String         @id @default(cuid())
  name              String         @unique
  tags              String[]
  productionVersion Int            @default(1)
  versions          SkillVersion[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

/// SkillVersion — 不可变的版本快照
model SkillVersion {
  id          String   @id @default(cuid())
  skillId     String
  skill       Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  version     Int
  description String
  content     String
  metadata    Json?
  createdAt   DateTime @default(now())

  @@unique([skillId, version])
  @@index([skillId])
}

/// User — 轻量用户标识，无密码，按 name 区分
model User {
  id       String        @id @default(cuid())
  name     String        @unique
  sessions ChatSession[]
}

/// ChatSession — 对话会话，持久化多轮对话，按 user 隔离
model ChatSession {
  id        String        @id @default(cuid())
  title     String?
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([userId])
}

/// ChatMessage — 单条对话消息
model ChatMessage {
  id         String      @id @default(cuid())
  sessionId  String
  session    ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role       String      // "user" | "assistant" | "tool"
  content    String?
  toolCalls  Json?       // OpenAI tool_calls 数组
  toolCallId String?
  createdAt  DateTime    @default(now())

  @@index([sessionId, createdAt])
}

/// McpServer — 动态 MCP，JS 代码存储于 DB，运行于 QuickJS WebAssembly 沙盒
/// 实体表保留身份 + 运行时字段，代码存在 McpServerVersion
model McpServer {
  id                String             @id @default(cuid())
  name              String             @unique
  enabled           Boolean            @default(true)
  config            Json?
  productionVersion Int                @default(1)
  versions          McpServerVersion[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

/// McpServerVersion — 不可变的版本快照
model McpServerVersion {
  id          String    @id @default(cuid())
  mcpServerId String
  mcpServer   McpServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)
  version     Int
  description String?
  code        String
  createdAt   DateTime  @default(now())

  @@unique([mcpServerId, version])
  @@index([mcpServerId])
}
