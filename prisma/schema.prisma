generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Skill — 遵循 Agent Skills 开放标准 (agentskills.io)
/// 实体表只保留身份字段 + production 指针，内容存在 SkillVersion
model Skill {
  id                String         @id @default(cuid())
  name              String         @unique
  tags              String[]
  productionVersion Int            @default(1)
  versions          SkillVersion[]
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
}

/// SkillVersion — 不可变的版本快照
model SkillVersion {
  id          String   @id @default(cuid())
  skillId     String
  skill       Skill    @relation(fields: [skillId], references: [id], onDelete: Cascade)
  version     Int
  description String
  content     String
  metadata    Json?
  createdAt   DateTime @default(now())

  @@unique([skillId, version])
  @@index([skillId])
}

/// User — 轻量用户标识，无密码，按 name 区分
model User {
  id       String        @id @default(cuid())
  name     String        @unique
  sessions ChatSession[]
}

/// ChatSession — 对话会话，持久化多轮对话，按 user 隔离
model ChatSession {
  id        String        @id @default(cuid())
  title     String?
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([userId])
}

/// ChatMessage — 单条对话消息
model ChatMessage {
  id         String      @id @default(cuid())
  sessionId  String
  session    ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  role       String      // "user" | "assistant" | "tool"
  content    String?
  images     String[]    // 附带的图片 URL 列表（视觉模型用）
  toolCalls  Json?       // OpenAI tool_calls 数组
  toolCallId String?
  createdAt  DateTime    @default(now())

  @@index([sessionId, createdAt])
}

/// McpServer — 动态 MCP，JS 代码存储于 DB，运行于 QuickJS WebAssembly 沙盒
/// 实体表保留身份 + 运行时字段，代码存在 McpServerVersion
model McpServer {
  id                String             @id @default(cuid())
  name              String             @unique
  enabled           Boolean            @default(true)
  config            Json?
  productionVersion Int                @default(1)
  versions          McpServerVersion[]
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

/// McpServerVersion — 不可变的版本快照
model McpServerVersion {
  id          String    @id @default(cuid())
  mcpServerId String
  mcpServer   McpServer @relation(fields: [mcpServerId], references: [id], onDelete: Cascade)
  version     Int
  description String?
  code        String
  createdAt   DateTime  @default(now())

  @@unique([mcpServerId, version])
  @@index([mcpServerId])
}

/// BizTableMapping — 逻辑表名到物理表名(UUID)的映射，实现 biz-db 用户隔离
/// userName="_global_" 表示全局表，其他值为用户私有表
model BizTableMapping {
  id           String   @id @default(cuid())
  userName     String
  logicalName  String
  physicalName String   @unique
  createdAt    DateTime @default(now())

  @@unique([userName, logicalName])
  @@index([userName])
}

/// Api — 对外 CRUD 接口，声明式 SQL 操作绑定 biz-db 数据
/// 实体表保留身份 + 启用状态 + production 指针，内容存在 ApiVersion
model Api {
  id                String       @id @default(cuid())
  name              String       @unique
  description       String
  enabled           Boolean      @default(true)
  productionVersion Int          @default(1)
  versions          ApiVersion[]
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
}

/// ApiVersion — 不可变的版本快照
model ApiVersion {
  id          String   @id @default(cuid())
  apiId       String
  api         Api      @relation(fields: [apiId], references: [id], onDelete: Cascade)
  version     Int
  description String?
  schema      Json     /// 数据模型定义（表、字段、类型）
  operations  Json     /// 操作定义数组（声明式 SQL + 参数定义）
  createdAt   DateTime @default(now())

  @@unique([apiId, version])
  @@index([apiId])
}
